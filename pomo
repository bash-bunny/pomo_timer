#!/usr/bin/sh

# Get the timer from the user
ACTUAL_DATE=$(date +%s)
TIME="${1}"

print_help() {
  printf "Usage: \n# Focus 45 minutes\npomo 45m\n# Focus 1 hour\npomo 1h\n"
  exit 1
}

# Check if other pomodoro exists and if so exit
check_pomo() {
	for i in $(atq | awk '{print $1}');
	do
		if at -c "${i}" | grep -i pomo &>/dev/null; then
			notify-send "Pomo" "You already have a pomo until: $(atq "${i}" | awk '{print $5}')"
			exit 1
		fi
	done
}

# Convert m or h into minutes and hours
focus_time() {
	# Time to focus
  num="${1}"
	# Unit timer
	unit="${2}"

	case "${unit}" in
		"m")
			seconds=$((60 * "${num}"))
			send_notification "${num}" "minutes" "${seconds}"
			;;
		"h")
			seconds=$((3600 * "${num}"))
			send_notification "${num}" "hours" "${seconds}"
			;;
		*)
			print_help
			;;
	esac
}

send_notification() {
	num="${1}"
	unit="${2}"
	seconds="${3}"
	# Get the date until it focus
	total_time=$((${ACTUAL_DATE} + ${seconds}))
	# Calculate the final hour where the timer expire
	timer_expire=$(date --date="@${total_time}" +%R)
	# Send init notification
	notify-send "Pomo" "Focus time until ${timer_expire}!"
	# Set finish notification
	echo 'notify-send "Pomo" "Focus is over"' | at now + "${num}" "${unit}" &>/dev/null
}

# If no time specified by the user RTFM
if [[ -z "${TIME}" ]]; then
	print_help
fi

# Check existing pomodoro sessions
check_pomo

# Extract the number and unit
num="${TIME//[!0-9]/}"
unit="${TIME//[0-9]/}"

# Calculate the seconds
focus_time "${num}" "${unit}"
